#!/bin/bash
# ะะฒัะพะผะฐัะธัะตัะบะฐั ัััะฐะฝะพะฒะบะฐ ะพะฑะฝะพะฒะปะตะฝะธะน v2.0

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ        ะฃะกะขะะะะะะ ะะะะะะะะะะ v2.0                               โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะพะฒะตัะบะฐ ัะตะบััะตะน ะดะธัะตะบัะพัะธะธ
if [ ! -f "docker-compose.yml" ]; then
    echo "โ ะัะธะฑะบะฐ: docker-compose.yml ะฝะต ะฝะฐะนะดะตะฝ"
    echo "   ะัะฟะพะปะฝะธัะต: cd ~/Desktop/Rabota-document-generator"
    exit 1
fi

echo "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
echo ""

# ะจะฐะณ 1: ะััะฐะฝะพะฒะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ
echo "๐ ะััะฐะฝะพะฒะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose down
echo "โ ะะพะฝัะตะนะฝะตัั ะพััะฐะฝะพะฒะปะตะฝั"
echo ""

# ะจะฐะณ 2: Backup
echo "๐พ ะกะพะทะดะฐะฝะธะต backup..."
if [ -f "docker-compose.yml" ]; then
    cp docker-compose.yml docker-compose.yml.backup.$(date +%Y%m%d_%H%M%S)
fi
if [ -f "Dockerfile" ]; then
    cp Dockerfile Dockerfile.backup.$(date +%Y%m%d_%H%M%S)
fi
echo "โ Backup ัะพะทะดะฐะฝ"
echo ""

# ะจะฐะณ 3: ะัะพะฒะตัะบะฐ ะฝะพะฒัั ัะฐะนะปะพะฒ
echo "๐ ะัะพะฒะตัะบะฐ ะฝะพะฒัั ัะฐะนะปะพะฒ..."
missing_files=0

if [ ! -f "docker-compose-UPDATED.yml" ]; then
    echo "โ docker-compose-UPDATED.yml ะฝะต ะฝะฐะนะดะตะฝ"
    missing_files=$((missing_files+1))
fi

if [ ! -f "Dockerfile-UPDATED" ]; then
    echo "โ Dockerfile-UPDATED ะฝะต ะฝะฐะนะดะตะฝ"
    missing_files=$((missing_files+1))
fi

if [ ! -f "generate_report.sh" ]; then
    echo "โ generate_report.sh ะฝะต ะฝะฐะนะดะตะฝ"
    missing_files=$((missing_files+1))
fi

if [ ! -f "report_generator_v2.py" ]; then
    echo "โ report_generator_v2.py ะฝะต ะฝะฐะนะดะตะฝ"
    missing_files=$((missing_files+1))
fi

if [ ! -f "ะะฐะฑะพัะธะต_ัะฐะฑะป_ะกะะ_v2.xlsx" ]; then
    echo "โ ะะฐะฑะพัะธะต_ัะฐะฑะป_ะกะะ_v2.xlsx ะฝะต ะฝะฐะนะดะตะฝ"
    missing_files=$((missing_files+1))
fi

if [ $missing_files -gt 0 ]; then
    echo ""
    echo "โ ะะต ัะฒะฐัะฐะตั $missing_files ัะฐะนะป(ะพะฒ)"
    echo "   ะกะบะฐัะฐะนัะต ะฒัะต ัะฐะนะปั ะธะท ัะฐัะฐ ะธ ะฟะพะฒัะพัะธัะต ะฟะพะฟััะบั"
    exit 1
fi

echo "โ ะัะต ัะฐะนะปั ะฝะฐ ะผะตััะต"
echo ""

# ะจะฐะณ 4: ะะฐะผะตะฝะฐ ัะฐะนะปะพะฒ
echo "๐ ะะฐะผะตะฝะฐ ะบะพะฝัะธะณััะฐัะธะธ..."
mv docker-compose-UPDATED.yml docker-compose.yml
mv Dockerfile-UPDATED Dockerfile
chmod +x generate_report.sh
echo "โ ะะพะฝัะธะณััะฐัะธั ะพะฑะฝะพะฒะปะตะฝะฐ"
echo ""

# ะจะฐะณ 5: ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน
echo "๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะน..."
mkdir -p output logs files
chmod 777 output logs files
echo "โ ะะธัะตะบัะพัะธะธ ะณะพัะพะฒั"
echo ""

# ะจะฐะณ 6: ะะตัะตัะฑะพัะบะฐ
echo "๐จ ะะตัะตัะฑะพัะบะฐ Docker ะพะฑัะฐะทะพะฒ (ััะพ ะทะฐะนะผะตั 2-3 ะผะธะฝััั)..."
docker-compose build --no-cache
echo "โ ะะฑัะฐะทั ะฟะตัะตัะพะฑัะฐะฝั"
echo ""

# ะจะฐะณ 7: ะะฐะฟััะบ
echo "๐ ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose up -d
sleep 5
echo "โ ะะพะฝัะตะนะฝะตัั ะทะฐะฟััะตะฝั"
echo ""

# ะจะฐะณ 8: ะัะพะฒะตัะบะฐ
echo "๐ ะัะพะฒะตัะบะฐ ััะฐัััะฐ..."
docker-compose ps
echo ""

# ะจะฐะณ 9: ะขะตัั
echo "๐งช ะขะตััะพะฒะฐั ะณะตะฝะตัะฐัะธั ะพััะตัะฐ..."
./generate_report.sh 1 2026

if [ -f "output/ะพััะตั_1_2026.xlsx" ]; then
    echo ""
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo "โ  โ ะฃะกะขะะะะะะ ะฃะกะะะจะะ ะะะะะะจะะะ!                               โ"
    echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
    echo ""
    echo "๐ ะขะตััะพะฒัะน ะพััะตั ัะพะทะดะฐะฝ: output/ะพััะตั_1_2026.xlsx"
    echo ""
    echo "๐ฏ ะงัะพ ะดะฐะปััะต:"
    echo "  โข ะะฐะฟะพะปะฝะธัะต ัะฐะฑะปะธัั: ะะฐะฑะพัะธะต_ัะฐะฑะป_ะกะะ_v2.xlsx"
    echo "  โข ะะตะฝะตัะธััะนัะต ะพััะตัั: ./generate_report.sh <ะผะตััั> <ะณะพะด>"
    echo "  โข ะะตะฑ-ะธะฝัะตััะตะนั: http://localhost:5000"
    echo ""
    echo "๐ ะะพะบัะผะตะฝัะฐัะธั:"
    echo "  โข README_v2.md - ะพัะฝะพะฒะฝะฐั ะธะฝััััะบัะธั"
    echo "  โข INTEGRATION_README.md - ะธะฝัะตะณัะฐัะธั ั ะฟัะพะตะบัะพะผ"
    echo ""
else
    echo ""
    echo "โ๏ธ  ะััะตั ะฝะต ัะพะทะดะฐะฝ, ะฟัะพะฒะตัััะต ะปะพะณะธ:"
    echo "   docker-compose logs report-generator"
fi
