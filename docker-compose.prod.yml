version: '3.8'

# ============================================================
# PRODUCTION CONFIG - использует образ из Docker Hub
# С АВТОМАТИЧЕСКИМ ОБНОВЛЕНИЕМ ЧЕРЕЗ WATCHTOWER
# ============================================================

services:
  # ============================================================
  # ВЕБ-ИНТЕРФЕЙС (основной сервис)
  # ============================================================
  web:
    # Используем образ из Docker Hub
    image: ${DOCKERHUB_USERNAME}/severen-generator:latest
    container_name: severen-web
    ports:
      - "${WEB_PORT:-5000}:5000"
    volumes:
      # Монтируем только данные (не код!)
      - ./output:/app/output
      - ./data:/app/data
      - ./email_templates:/app/email_templates
      - ./excel_files:/app/excel_files
    environment:
      - TRELLO_API_KEY=${TRELLO_API_KEY}
      - TRELLO_TOKEN=${TRELLO_TOKEN}
      - TRELLO_BOARD_ID=${TRELLO_BOARD_ID:-gfcln6rS}
      - EXCEL_PATH=${EXCEL_PATH:-/app/excel_files/ПРИЛОЖЕНИЕ_1_3_4_ALL_IN_ONE.xlsx}
      - FLASK_ENV=${FLASK_ENV:-production}
      - SECRET_KEY=${SECRET_KEY}
    restart: unless-stopped
    networks:
      - severen-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      # Watchtower будет мониторить этот контейнер
      - "com.centurylinklabs.watchtower.enable=true"

  # ============================================================
  # WATCHTOWER - АВТОМАТИЧЕСКОЕ ОБНОВЛЕНИЕ КОНТЕЙНЕРОВ
  # ============================================================
  watchtower:
    image: containrrr/watchtower:latest
    container_name: severen-watchtower
    volumes:
      # Доступ к Docker socket для управления контейнерами
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Проверка обновлений каждые 5 минут (300 секунд)
      - WATCHTOWER_POLL_INTERVAL=300
      # Автоматическая очистка старых образов
      - WATCHTOWER_CLEANUP=true
      # Мониторить только контейнеры с label
      - WATCHTOWER_LABEL_ENABLE=true
      # Таймаут для остановки контейнера (10 секунд)
      - WATCHTOWER_TIMEOUT=10s
      # Включить rolling restart (обновление по одному)
      - WATCHTOWER_ROLLING_RESTART=true
    restart: unless-stopped
    networks:
      - severen-network
    labels:
      # Watchtower не обновляет сам себя
      - "com.centurylinklabs.watchtower.enable=false"

networks:
  severen-network:
    driver: bridge
