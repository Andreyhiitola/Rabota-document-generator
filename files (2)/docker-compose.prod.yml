version: '3.8'

services:
  web:
    image: andreysagurov/severen-generator:latest
    container_name: severen-web
    ports:
      - "5000:5000"
    env_file:
      - .env
    volumes:
      - ./excel_files:/app/excel_files
      - ./output:/app/output
    restart: unless-stopped
    networks:
      - severen-network

  sync:
    image: andreysagurov/severen-generator:latest
    container_name: severen-sync
    env_file:
      - .env
    volumes:
      - ./excel_files:/app/excel_files
      - /tmp:/tmp
    command: python3 /app/full_sync.py
    restart: "no"
    networks:
      - severen-network
    profiles:
      - sync

  auto-sync:
    image: andreysagurov/severen-generator:latest
    container_name: severen-auto-sync
    env_file:
      - .env
    volumes:
      - ./excel_files:/app/excel_files
      - /tmp:/tmp
    command: >
      sh -c "while true; do
        echo '========================================';
        echo 'Запуск синхронизации...';
        echo '========================================';
        python3 /app/full_sync.py;
        echo '';
        echo 'Следующая синхронизация через $${SYNC_INTERVAL:-60} минут';
        sleep $$(($${SYNC_INTERVAL:-60} * 60));
      done"
    restart: unless-stopped
    networks:
      - severen-network
    profiles:
      - auto-sync

networks:
  severen-network:
    driver: bridge
