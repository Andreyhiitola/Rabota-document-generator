# 📊 ГЕНЕРАТОР ОТЧЁТОВ - РУКОВОДСТВО

## 🎯 Что это?

**Элегантное решение для автоматической генерации отчётов:**
- ✅ ПРИЛОЖЕНИЕ 1 (Задание на выполнение работ)
- ✅ ПРИЛОЖЕНИЕ 3 (Отчёт о выполненных работах)  
- ✅ ПРИЛОЖЕНИЕ 4 (Акт выполненных работ)

## ✨ Ключевые возможности

### 1. Обработка транзитных адресов
```
Автоматически определяет и форматирует:
"Гатчина, Красносельское шоссе, д.1А. Транзитные адреса: Изотова 12-2, Изотова 13"

Результат:
┌────────────────────────────────────────┐
│ Гатчина, Красносельское шоссе, д.1А    │ ← Объединённая ячейка
│ Транзит: Изотова 12-2                  │   на несколько строк
│ Транзит: Изотова 13                    │
└────────────────────────────────────────┘
```

### 2. Автоформатирование
```
✅ Объединение ячеек для транзитов
✅ Автоширина колонок
✅ Границы ячеек
✅ Выравнивание текста
✅ Шрифты и размеры
```

### 3. Выпадающие списки
```
В колонке "Вид услуги" автоматически добавляется список:
1. Консультации по размещению кабельных линий
2. Согласование с ЖКС/ГУПРЭП
3. Согласование работ по кабельным линиям с ТСЖ/УК
4. Согласование работ (транзитные/аварийные)
5. Согласование работ по монтажу по фасадам зданий
6. Согласование доступа в подвалы/чердаки
7. Согласование доступа в ТЦ/БЦ
```

---

## 🚀 Использование

### Вариант 1: Из командной строки

```bash
python3 report_generator.py \
  --source /path/to/workbook.xlsx \
  --output /path/to/report.xlsx \
  --month 9 \
  --year 2025 \
  --client "ПАО Ростелеком"
```

### Вариант 2: Из Python кода

```python
from report_generator import generate_monthly_report

generate_monthly_report(
    source_file='/app/excel_files/workbook.xlsx',
    output_file='/app/output/ПРИЛОЖЕНИЕ_1_Сентябрь_2025.xlsx',
    month=9,
    year=2025,
    client='ПАО Ростелеком'
)
```

### Вариант 3: Интеграция с Trello sync

```python
# В full_sync.py после синхронизации с Trello:

from report_generator import generate_monthly_report

# Генерируем отчёт за текущий месяц
generate_monthly_report(
    source_file=local_file,
    output_file='/app/output/report.xlsx',
    month=datetime.now().month,
    year=datetime.now().year
)
```

---

## 📋 Формат данных

### Входные данные (рабочая таблица):

```
Колонка A: № работы
Колонка E: Адрес (может содержать "Транзитные адреса:")
Колонка I: Стоимость
Колонка J: Вид услуги
Колонка R: Статус
Колонка V: Клиент
Колонка Z: Начало работ
Колонка AB: Исполнитель
```

### Выходные данные (отчёт):

```
Задание_Отчет:
├─ Заголовок (ПРИЛОЖЕНИЕ № 1)
├─ Период и клиент
├─ Таблица:
│  ├─ Адрес предоставления услуги
│  ├─ Дата передачи задания
│  ├─ Дата выполнения задания
│  └─ Вид оказанной услуги (с выпадающим списком)
└─ Автоформатирование и объединение ячеек
```

---

## 🎨 Обработка транзитных адресов

### Формат 1: С ключевым словом
```
Гатчина, Красносельское шоссе, д.1А. Транзитные адреса: Изотова 12-2, Изотова 13
```

### Формат 2: Сокращённый
```
Санкт-Петербург, Шуваловский 41. Транзиты: дом 42, дом 43
```

### Формат 3: В описании карточки
```
Если в описании Trello есть поле "Транзитные адреса:",
они будут автоматически распознаны
```

---

## ⚙️ Настройка под себя

### Изменение колонок источника:

В файле `report_generator.py` найдите:

```python
# Определяем колонки (индексы в вашей таблице)
COL_ADDR = 5    # E - Адрес
COL_START = 26  # Z - Начало работ
COL_CLIENT = 22 # V - Клиент
# ... и т.д.
```

Измените индексы под вашу структуру!

### Изменение выпадающего списка:

```python
services_list = [
    "1. Ваш вариант услуги",
    "2. Другой вариант",
    # ...
]
```

### Изменение стилей:

```python
header_font = Font(name='Arial', size=11, bold=True)
normal_font = Font(name='Arial', size=10)
# ...
```

---

## 🔧 Интеграция в существующую систему

### Шаг 1: Обновите full_sync.py

Добавьте в конец файла `full_sync.py`:

```python
from report_generator import generate_monthly_report

def full_sync():
    # ... существующий код синхронизации ...
    
    # НОВОЕ: Генерация отчёта после синхронизации
    logger.info("")
    logger.info("=" * 80)
    logger.info("ШАГ 4/4: ГЕНЕРАЦИЯ ОТЧЁТА")
    logger.info("=" * 80)
    
    report_file = f'/app/output/ПРИЛОЖЕНИЕ_месяц_{datetime.now().month}_{datetime.now().year}.xlsx'
    
    success = generate_monthly_report(
        source_file=local_file,
        output_file=report_file,
        month=datetime.now().month,
        year=datetime.now().year
    )
    
    if success:
        logger.info(f"✅ Отчёт сохранён: {report_file}")
    
    return True
```

### Шаг 2: Обновите requirements_full.txt

Убедитесь что есть строка:
```
openpyxl==3.1.2
```

### Шаг 3: Пересоберите Docker образ

```bash
docker compose build
```

---

## 📊 Пример результата

```
ПРИЛОЖЕНИЕ_1_Сентябрь_2025.xlsx:

┌──────────────────────────────────────┬────────────┬────────────┬──────────────────────┐
│ Адрес                                │ Дата       │ Дата       │ Вид услуги           │
│                                      │ передачи   │ выполнения │                      │
├──────────────────────────────────────┼────────────┼────────────┼──────────────────────┤
│ СПб, Революции 20                    │ 01.09.2025 │ 30.09.2025 │ [Выпадающий список] │
├──────────────────────────────────────┼────────────┼────────────┼──────────────────────┤
│ Гатчина, Красносельское 1А           │            │            │                      │
│ Транзит: Изотова 12-2                │ 05.09.2025 │ 30.09.2025 │ [Выпадающий список] │
│ Транзит: Изотова 13                  │            │            │                      │
├──────────────────────────────────────┼────────────┼────────────┼──────────────────────┤
│ ...                                  │ ...        │ ...        │ ...                  │
└──────────────────────────────────────┴────────────┴────────────┴──────────────────────┘
```

---

## 🐛 Устранение проблем

### Проблема: "Транзитные адреса не распознаются"

**Решение:** Убедитесь что в адресе есть текст "Транзитные адреса:" или "Транзиты:"

### Проблема: "Неправильные колонки"

**Решение:** Проверьте индексы колонок в `COL_ADDR`, `COL_START` и т.д.

### Проблема: "Отчёт пустой"

**Решение:** Проверьте фильтрацию по датам и наличие данных в исходной таблице

---

## 📞 Дополнительная информация

**Файлы системы:**
- `report_generator.py` - Основной генератор
- `full_sync.py` - Интеграция с Trello
- `README_REPORTS.md` - Эта документация

**Логи:**
```bash
# Просмотр логов генерации
tail -f /tmp/report_generation.log
```

**Тестирование:**
```bash
# Тест генератора
python3 report_generator.py \
  --source test_data.xlsx \
  --output test_report.xlsx \
  --month 1 \
  --year 2026
```

---

## ✅ Чеклист готовности

```
☐ report_generator.py создан
☐ Проверены индексы колонок
☐ Протестирована генерация одного отчёта
☐ Интегрировано в full_sync.py
☐ Обновлён requirements_full.txt
☐ Пересобран Docker образ
☐ Протестирована полная синхронизация
☐ Отчёты генерируются автоматически
```

---

**Версия:** 1.0  
**Дата:** 22.01.2026  
**Автор:** Система автоматизации "Северен"
